(function(){"use strict";var e=function(e){var t=function(t,n){this.el=e(t);this.zoomFactor=1;this.lastScale=1;this.offset={x:0,y:0};this.options=e.extend({},this.defaults,n);this.setupMarkup();this.bindEvents();this.update()},n=function(e,t){return e+t},r=function(e,t){return e>t-.01&&e<t+.01};t.prototype={defaults:{tapZoomFactor:2,zoomOutFactor:1.3,animationDuration:300,animationInterval:5,maxZoom:4,minZoom:.5,use2d:true},handleDragStart:function(e){this.stopAnimation();this.lastDragPosition=false;this.hasInteraction=true;this.handleDrag(e)},handleDrag:function(e){if(this.zoomFactor>1){var t=this.getTouches(e)[0];this.drag(t,this.lastDragPosition);this.offset=this.sanitizeOffset(this.offset);this.lastDragPosition=t}},handleDragEnd:function(){this.end()},handleZoomStart:function(e){this.stopAnimation();this.lastScale=1;this.nthZoom=0;this.lastZoomCenter=false;this.hasInteraction=true},handleZoom:function(e,t){var n=this.getTouchCenter(this.getTouches(e)),r=t/this.lastScale;this.lastScale=t;this.nthZoom+=1;if(this.nthZoom>3){this.scale(r,n);this.drag(n,this.lastZoomCenter)}this.lastZoomCenter=n},handleZoomEnd:function(){this.end()},handleDoubleTap:function(e){var t=this.getTouches(e)[0],n=this.zoomFactor>1?1:this.options.tapZoomFactor,r=this.zoomFactor,i=function(e){this.scaleTo(r+e*(n-r),t)}.bind(this);if(this.hasInteraction){return}if(r>n){t=this.getCurrentZoomCenter()}this.animate(this.options.animationDuration,this.options.animationInterval,i,this.swing)},sanitizeOffset:function(e){var t=(this.zoomFactor-1)*this.getContainerX(),n=(this.zoomFactor-1)*this.getContainerY(),r=Math.max(t,0),i=Math.max(n,0),s=Math.min(t,0),o=Math.min(n,0);return{x:Math.min(Math.max(e.x,s),r),y:Math.min(Math.max(e.y,o),i)}},scaleTo:function(e,t){this.scale(e/this.zoomFactor,t)},scale:function(e,t){e=this.scaleZoomFactor(e);this.addOffset({x:(e-1)*(t.x+this.offset.x),y:(e-1)*(t.y+this.offset.y)})},scaleZoomFactor:function(e){var t=this.zoomFactor;this.zoomFactor*=e;this.zoomFactor=Math.min(this.options.maxZoom,Math.max(this.zoomFactor,this.options.minZoom));return this.zoomFactor/t},drag:function(e,t){if(t){this.addOffset({x:-(e.x-t.x),y:-(e.y-t.y)})}},getTouchCenter:function(e){return this.getVectorAvg(e)},getVectorAvg:function(e){return{x:e.map(function(e){return e.x}).reduce(n)/e.length,y:e.map(function(e){return e.y}).reduce(n)/e.length}},addOffset:function(e){this.offset={x:this.offset.x+e.x,y:this.offset.y+e.y}},sanitize:function(){if(this.zoomFactor<this.options.zoomOutFactor){this.zoomOutAnimation()}else if(this.isInsaneOffset(this.offset)){this.sanitizeOffsetAnimation()}},isInsaneOffset:function(e){var t=this.sanitizeOffset(e);return t.x!==e.x||t.y!==e.y},sanitizeOffsetAnimation:function(){var e=this.sanitizeOffset(this.offset),t={x:this.offset.x,y:this.offset.y},n=function(n){this.offset.x=t.x+n*(e.x-t.x);this.offset.y=t.y+n*(e.y-t.y);this.update()}.bind(this);this.animate(this.options.animationDuration,this.options.animationInterval,n,this.swing)},zoomOutAnimation:function(){var e=this.zoomFactor,t=1,n=this.getCurrentZoomCenter(),r=function(r){this.scaleTo(e+r*(t-e),n)}.bind(this);this.animate(this.options.animationDuration,this.options.animationInterval,r,this.swing)},updateAspectRatio:function(){this.setContainerY(this.getContainerX()/this.getAspectRatio())},getInitialZoomFactor:function(){return this.container.width()/this.el.width()},getAspectRatio:function(){return this.el.width()/this.el.height()},getCurrentZoomCenter:function(){var e=this.container.width()*this.zoomFactor,t=this.offset.x,n=e-t-this.container.width(),r=t/n,i=r*this.container.width()/(r+1),s=this.container.height()*this.zoomFactor,o=this.offset.y,u=s-o-this.container.height(),a=o/u,f=a*this.container.height()/(a+1);if(n===0){i=this.container.width()}if(u===0){f=this.container.height()}return{x:i,y:f}},canDrag:function(){return!r(this.zoomFactor,1)},getTouches:function(e){var t=this.container.offset();return Array.prototype.slice.call(e.touches).map(function(e){return{x:e.pageX-t.left,y:e.pageY-t.top}})},animate:function(e,t,n,r,i){var s=(new Date).getTime(),o=function(){if(!this.inAnimation){return}var u=(new Date).getTime()-s,a=u/e;if(u>=e){n(1);if(i){i()}this.update();this.stopAnimation();this.update()}else{if(r){a=r(a)}n(a);this.update();setTimeout(o,t)}}.bind(this);this.inAnimation=true;o()},stopAnimation:function(){this.inAnimation=false},swing:function(e){return-Math.cos(e*Math.PI)/2+.5},getContainerX:function(){return this.container.width()},getContainerY:function(){return this.container.height()},setContainerY:function(e){return this.container.height(e)},setupMarkup:function(){this.container=e('<div class="pinch-zoom-container"></div>');this.el.before(this.container);this.container.append(this.el);this.container.css({overflow:"hidden",position:"relative"});this.el.css({webkitTransformOrigin:"0% 0%",mozTransformOrigin:"0% 0%",msTransformOrigin:"0% 0%",oTransformOrigin:"0% 0%",transformOrigin:"0% 0%",position:"absolute"})},end:function(){this.hasInteraction=false;this.sanitize();this.update()},bindEvents:function(){i(this.container.get(0),this);e(window).bind("resize",this.update.bind(this));e(this.el).find("img").bind("load",this.update.bind(this))},update:function(){if(this.updatePlaned){return}this.updatePlaned=true;setTimeout(function(){this.updatePlaned=false;this.updateAspectRatio();var e=this.getInitialZoomFactor()*this.zoomFactor,t=-this.offset.x/e,n=-this.offset.y/e,r="scale3d("+e+", "+e+",1) "+"translate3d("+t+"px,"+n+"px,0px)",i="scale("+e+", "+e+") "+"translate("+t+"px,"+n+"px)",s=function(){if(this.clone){this.clone.remove();delete this.clone}}.bind(this);if(!this.options.use2d||this.hasInteraction||this.inAnimation){this.is3d=true;s();this.el.css({webkitTransform:r,oTransform:i,msTransform:i,mozTransform:i,transform:r})}else{if(this.is3d){this.clone=this.el.clone();this.clone.css("pointer-events","none");this.clone.appendTo(this.container);setTimeout(s,200)}this.el.css({webkitTransform:i,oTransform:i,msTransform:i,mozTransform:i,transform:i});this.is3d=false}}.bind(this),0)}};var i=function(e,t){var n=null,r=0,i=null,s=null,o=function(e,r){if(n!==e){if(n&&!e){switch(n){case"zoom":t.handleZoomEnd(r);break;case"drag":t.handleDragEnd(r);break}}switch(e){case"zoom":t.handleZoomStart(r);break;case"drag":t.handleDragStart(r);break}}n=e},u=function(e){if(r===2){o("zoom")}else if(r===1&&t.canDrag()){o("drag",e)}else{o(null,e)}},a=function(e){return Array.prototype.slice.call(e).map(function(e){return{x:e.pageX,y:e.pageY}})},f=function(e,t){var n,r;n=e.x-t.x;r=e.y-t.y;return Math.sqrt(n*n+r*r)},l=function(e,t){var n=f(e[0],e[1]),r=f(t[0],t[1]);return r/n},c=function(e){e.stopPropagation();e.preventDefault()},h=function(e){var s=(new Date).getTime();if(r>1){i=null}if(s-i<300){c(e);t.handleDoubleTap(e);switch(n){case"zoom":t.handleZoomEnd(e);break;case"drag":t.handleDragEnd(e);break}}if(r===1){i=s}},p=true;e.addEventListener("touchstart",function(e){p=true;r=e.touches.length;h(e)});e.addEventListener("touchmove",function(e){if(p){u(e);if(n){c(e)}s=a(e.touches)}else{switch(n){case"zoom":t.handleZoom(e,l(s,a(e.touches)));break;case"drag":t.handleDrag(e);break}if(n){c(e);t.update()}}p=false});e.addEventListener("touchend",function(e){r=e.touches.length;u(e)})};return t};if(typeof define!=="undefined"&&define.amd){define(["jquery"],function(t){return e(t)})}else{window.RTP=window.RTP||{};window.RTP.PinchZoom=e(jQuery)}}).call(this)